\ProvidesPackage{glosmathtools}%
[%
2019/07/18 v0.3 %
Mathematical nomenclature tools for glossaries package %
Francis Gagnon %
]%
\RequirePackage{glossaries,amsmath,amsfonts,etoolbox}%

% ===========================================================================
% =================== PACKAGE OPTIONS =======================================
% ===========================================================================
% define char '"' as shortcut for "sbu" macro in math mode
% define qtmark macro to show the quotation mark character
\DeclareOption{qtmarkupright}{%
	\begingroup\lccode`~=`"\lowercase{\endgroup\def~}#1{\sbu{#1}}%
	\mathchardef\qtmark=\mathcode`"\AtBeginDocument{\mathcode`"=\string"8000}%
}%

\ProcessOptions\relax%

% ===========================================================================
% =================== PUBLIC MACROS =========================================
% ===========================================================================

% ---------- sbu -------------------------------------------------------
% "sbu" macro : shortcut for upright indices (ISO/NIST standard
% operatorfont for main document math font (serif or sans)
\newcommand*{\sbu}[1]{_{\operatorfont{#1}}}%

% ---------- newglosentrymath --------------------------------------------
% new glossary entry by adding ensuremath macro in the name field
% 3 arguments : glossary label, math symbol and {key=value list}
\newcommand*{\newglosentrymath}[3]%
{%
	\newglossaryentry{#1}{name={\ensuremath{#2}},#3}%
}%

% ---------- glsac ----------------------------------------------------------
% show $a$ with optionnal argument for accents
\newcommand*{\glsac}[2][]%
{%
	\glosmath@getMyGlsMacro{#1}%
	\ensuremath{\glsdisp{#2}{\glosmath@MyGlsMacro{#2}}}%
}%

% ---------- glsvi -------------------------------------------------------
% show $a_b$ with link to "a" and variable "b"
% 4 arguments : 2 mandatory arguments and optional 1st and 2nd argument
% for adding accent on "a" and "b"
\newcommand*{\glsvi}[1][]%
{%
	\def\glosmath@ArgI{#1}%
	\glosmath@glsviRelay%
}%

% ---------- glsub -------------------------------------------------------
% show $a_b$ with link to "a" and subscript "sub.b"
% 3 arguments : 2 mandatory arguments and optional 1st argument 
% for adding accents on "a"
\newcommand*{\glsub}[3][]%
{%
	\glosmath@getMyGlsMacro{#1}%
	\ensuremath{\glsdisp{#2}{\glosmath@MyGlsMacro{#2}_{\gls{sub.#3}}}}%
}%

% ---------- glsubs -------------------------------------------------------
% show $a_{b,c}$ with link "a", "sub.b" and "sub.c"
% 4 arguments : 4 mandatory arguments and optional 1st argument 
% for adding accents on "a" (dot,bar,hat or tilde)
\newcommand*{\glsubs}[4][]%
{%
	\glosmath@getMyGlsMacro{#1}%
	\glsadd{op.comma}%
	\ensuremath{%
		\glsdisp{#2}{%
			\glosmath@MyGlsMacro{#2}_{\gls{sub.#3},\gls{sub.#4}}%
		}%
	}%
	%\ensuremath{\glosmath@MyGlsMacro{#2}[\sbu{\gls{sub.#3},\gls{sub.#4}}]}%
}%

% ---------- glsfren ---------------------------------------------------------
% show accronyms definition in bilingual (ignoring the current style)
\newcommand*{\glsfren}[1]%
{%
	\let\oldfullformat\genacrfullformat%
	\renewcommand*{\genacrfullformat}[2]%
	{%
		\glsentrydescfr{##1}##2%
		\space(\firstacronymfont{\glsentryshort{##1}} pour %
		\textit{\glsentrydesc{##1}})%
	}%
	\gls{#1}%
	\let\genacrfullformat\oldfullformat%
}%


% ===========================================================================
% =================== GLOSSARIES STYLES =====================================
% ===========================================================================

% ---------- french nomenclature style -----------------------------------
\newglossarystyle{nomencl-fr}%
{%
	\setglossarystyle{alttree}% based on alttree style
	\renewenvironment{theglossary}%
	{%
		\let\glosmath@oldparskip\parskip\setlength{\parskip}{0pt}%
		\let\glosmath@oldparindent\parindent\setlength{\parindent}{0pt}%
	}%
	{%
		\setlength{\parskip}{\glosmath@oldparskip}%
		\setlength{\parindent}{\glosmath@oldparindent}%
	}%
	\renewcommand*{\glossaryheader}%
		{\ifcsname SingleSpacing\endcsname\SingleSpacing\fi}%
	\renewcommand*{\glossentry}[2]%
	{%
		\ifglsfieldeq{##1}{sort}{1}{}{\leavevmode\par}\glsentryitem{##1}%
		\glsentryitem{##1}%
		\glstarget{##1}{\glstreenamefmt{\glsentrydescfr{##1}}}%
		\par\nopagebreak%
	}%
	\renewcommand*{\subglossentry}[3]%
	{%
		\settowidth{\glstreeindent}{\@glswidestname\glstreepredesc}%
		\hangindent\glstreeindent%
		\settowidth{\glosmath@curNameLen}{\glossentryname{##2}\glstreepredesc}%
		\ifdimless{\glstreeindent}{\glosmath@curNameLen}{%
			\setlength{\glstreeindent}{\glosmath@curNameLen}}{}%
		\glstreenamebox{\glstreeindent}%
		{%
			\glsentryitem{##2}%
			\glstarget{##2}{\glossentryname{##2}}%
		}%
		\glsentrydescfr{##2}%
		\ifglshassymbol{##2}{,\space\glossentrysymbol{##2}}{}%
		\par%
	}%
}%

% ---------- english nomenclature style -----------------------------------
\newglossarystyle{nomencl-en}%
{%
	\setglossarystyle{alttree}% based on alttree style
	\renewenvironment{theglossary}%
	{%
		\let\glosmath@oldparskip\parskip\setlength{\parskip}{0pt}%
		\let\glosmath@oldparindent\parindent\setlength{\parindent}{0pt}%
	}%
	{%
		\setlength{\parskip}{\glosmath@oldparskip}%
		\setlength{\parindent}{\glosmath@oldparindent}%
	}%
	\renewcommand*{\glossaryheader}%
		{\ifcsname SingleSpacing\endcsname\SingleSpacing\fi}%
	\renewcommand*{\glossentry}[2]%
	{%
		\ifglsfieldeq{##1}{sort}{1}{}{\leavevmode\par}%
		\glsentryitem{##1}%
		\glstarget{##1}{\glstreenamefmt{\glsentrydesc{##1}}}%
		\par\nopagebreak%
	}%
	\renewcommand*{\subglossentry}[3]%
	{%
		\settowidth{\glstreeindent}{\@glswidestname\glstreepredesc}%
		\hangindent\glstreeindent%
		\settowidth{\glosmath@curNameLen}{\glossentryname{##2}\glstreepredesc}%
		\ifdimless{\glstreeindent}{\glosmath@curNameLen}{%
			\setlength{\glstreeindent}{\glosmath@curNameLen}}{}%
		\glstreenamebox{\glstreeindent}%
		{%
			\glsentryitem{##2}%
			\glstarget{##2}{\glossentryname{##2}}%
		}%
		\glsentrydesc{##2}%
		\ifglshassymbol{##2}{,\space\glossentrysymbol{##2}}{}%
		\par%
	}%
}%

% ---------- bilingual nomenclature style -----------------------------------
\newglossarystyle{nomencl-fr-en}%
{%
	\setglossarystyle{alttree}% based on alttree style
	\renewenvironment{theglossary}%
	{%
		\let\glosmath@oldparskip\parskip\setlength{\parskip}{0pt}%
		\let\glosmath@oldparindent\parindent\setlength{\parindent}{0pt}%
	}%
	{%
		\setlength{\parskip}{\glosmath@oldparskip}%
		\setlength{\parindent}{\glosmath@oldparindent}%
	}%
	\renewcommand*{\glossaryheader}%
		{\ifcsname SingleSpacing\endcsname\SingleSpacing\fi}%
	\renewcommand*{\glossentry}[2]%
	{%
		\ifglsfieldeq{##1}{sort}{1}{}{\leavevmode\par}\glsentryitem{##1}%
		\glstarget{##1}{\glstreenamefmt{\glsentrydescfr{##1}\space%
			(\textit{\glsentrydesc{##1}})}}%
		\par\nopagebreak%
	}%
	\renewcommand*{\subglossentry}[3]%
	{%
		\settowidth{\glstreeindent}{\@glswidestname\glstreepredesc}%
		\hangindent\glstreeindent%
		\settowidth{\glosmath@curNameLen}{\glossentryname{##2}\glstreepredesc}%
		\ifdimless{\glstreeindent}{\glosmath@curNameLen}{%
			\setlength{\glstreeindent}{\glosmath@curNameLen}}{}%
		\glstreenamebox{\glstreeindent}%
		{%
			\glsentryitem{##2}%
			\glstarget{##2}{\glossentryname{##2}}%
		}%
		\glsentrydescfr{##2}\space(\textit{\glsentrydesc{##2}})%
		\ifglshassymbol{##2}{,\space\glossentrysymbol{##2}}{}%
		\par%
	}%
}%

% ---------- accronyms english definition -----------------------------------
\newacronymstyle{en-acr}%
	{\GlsUseAcrEntryDispStyle{long-short}}% based on long-short style
	{\GlsUseAcrStyleDefs{long-short}}% based on long-short style

% ---------- accronyms french definition ------------------------------------
\newacronymstyle{fr-acr}%
	{\GlsUseAcrEntryDispStyle{long-short}}% based on long-short style
	{%
		\GlsUseAcrStyleDefs{long-short}% based on long-short style	
		\renewcommand*{\genacrfullformat}[2]%
			{\glsentrydescfr{##1}##2\space(\firstacronymfont{\glsentryshort{##1}})}%
		\renewcommand*{\genplacrfullformat}[2]%
			{\glsentrydescfr{##1}##2\space(\firstacronymfont{\glsentryshortpl{##1}})}%
		\let\Genacrfullformat\genacrfullformat%
		\let\Genplacrfullformat\genplacrfullformat%
	}%

% ---------- accronyms bilangual definition ---------------------------------
\newacronymstyle{fr-en-acr}%
	{\GlsUseAcrEntryDispStyle{long-short}}% based on long-short style
	{%
		\GlsUseAcrStyleDefs{long-short}% based on long-short style	
		\renewcommand*{\genacrfullformat}[2]%
			{%
				\glsentrydescfr{##1}##2%
				\space(\firstacronymfont{\glsentryshort{##1}} pour %
				\textit{\glsentrydesc{##1}})%
			}%
		\renewcommand*{\genplacrfullformat}[2]%
			{%
				\glsentrydescfr{##1}##2%
				\space(\firstacronymfont{\glsentryshortpl{##1}} pour %
				\textit{\glsentrydesc{##1}})%
			}%
		\let\Genacrfullformat\genacrfullformat%
		\let\Genplacrfullformat\genplacrfullformat%
	}%


% ===========================================================================
% =================== GLOSSARIES KEYS =======================================
% ===========================================================================

% ---------- french description key -----------------------------------------
\glsaddkey{descriptionfr}% key
{	% default value 
	\glsentrydesc{\glslabel}%
}{\glsentrydescfr}{\Glsentrydescfr}{\glsdescfr}{\Glsdescfr}{\GLSdescfr}% macros

% ---------- dot accent key ------------------------------------------------
\glsaddstoragekey{dot}% key
{	% default value
	\glsadd{op.dot}%
	\ensuremath{\dot{\glsentrytext{\glslabel}}}
}{\glsentrydot}
% ---------- ddot accent key -----------------------------------------------
\glsaddstoragekey{ddot}% key
{	% default value
	\glsadd{op.ddot}%
	\ensuremath{\ddot{\glsentrytext{\glslabel}}}%
}{\glsentryddot}
% ---------- bar accent key ------------------------------------------------
\glsaddstoragekey{bar}% key
{	% default value
	\glsadd{op.bar}%
	\ensuremath{\bar{\glsentrytext{\glslabel}}}%
}{\glsentrybar}
% ---------- hat accent key ------------------------------------------------
\glsaddstoragekey{hat}% key
{	% default value
	\glsadd{op.hat}%
	\ensuremath{\widehat{\glsentrytext{\glslabel}}}%
}{\glsentryhat}
% ---------- vec accent key ------------------------------------------------
\glsaddstoragekey{vec}% key
{	% default value
	\glsadd{op.vec}%
	\ensuremath{\vec{\glsentrytext{\glslabel}}}%
}{\glsentryvec}
% ---------- tilde accent key ----------------------------------------------
\glsaddstoragekey{tilde}% key
{	% default value
	\glsadd{op.tilde}%
	\ensuremath{\widetilde{\glsentrytext{\glslabel}}}%
}{\glsentrytilde}

% ===========================================================================
% =================== PRIVATE MACROS ========================================
% ===========================================================================

% ---------- glosmath@getMyGlsMacro -----------------------------------------
\newcommand*{\glosmath@getMyGlsMacro}[1]%
{%
	\let\glosmath@MyGlsMacro\glsentrytext%
	\notblank{#1}%
	{%
		\ifstrequal{#1}{dot}{\let\glosmath@MyGlsMacro\glsentrydot}%
		{%
		\ifstrequal{#1}{ddot}{\let\glosmath@MyGlsMacro\glsentryddot}%
		{%
		\ifstrequal{#1}{bar}{\let\glosmath@MyGlsMacro\glsentrybar}%
		{%
		\ifstrequal{#1}{hat}{\let\glosmath@MyGlsMacro\glsentryhat}%
		{%
		\ifstrequal{#1}{vec}{\let\glosmath@MyGlsMacro\glsentryvec}%
		{%
		\ifstrequal{#1}{tilde}{\let\glosmath@MyGlsMacro\glsentrytilde}%
		{%
			\PackageError{glosmathtools}{Unknown accent: #1}{}%
		}}}}}}%	
	}{}%
}%

% ---------- glosmath@glsviRelay ------------------------------------------
% relay macro for two optional aguments in the glsvi macro
\newcommand*{\glosmath@glsviRelay}[3][]%
{%
	\expandafter\glosmath@getMyGlsMacro\expandafter{\glosmath@ArgI}%
	\let\glosmath@FirGls\glosmath@MyGlsMacro%
	\glosmath@getMyGlsMacro{#1}%
	\let\glosmath@SecGls\glosmath@MyGlsMacro%
	\ensuremath{%
		\glsdisp{#2}{%
			\glosmath@FirGls{#2}_{\glsdisp{#3}{\glosmath@SecGls{#3}}}%
		}%
	}%
}%

% ---------- glosmath@curNameLen ------------------------------------------
% variable to store current entry length (for nomenclature styles)
\newlength{\glosmath@curNameLen}%
\setlength{\glosmath@curNameLen}{\glstreeindent}%

\endinput%