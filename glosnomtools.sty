\ProvidesPackage{glosnomtools}%
[2019/01/04 Math nomenclature tools for glossaries package (Francis Gagnon)]%
\RequirePackage%
{glossaries,etoolbox,mathtools,siunitx,amsmath,amsfonts,amssymb}%

% ===========================================================================
% =================== GLOSSARIES STYLES =====================================
% ===========================================================================

\newglossarystyle{nomencl_french}%
{%
	\setglossarystyle{alttree}% based on alttree style
	\renewcommand*{\glossentry}[2]%
	{%
		\ifglsfieldeq{##1}{sort}{1}{}{\leavevmode\par}%
		\glsentryitem{##1}%
		\glstarget{##1}{\textbf{\glsuseri*{##1}}}\par\nopagebreak%
	}%
	\renewcommand*{\subglossentry}[3]%
	{%
		\settowidth{\glstreeindent}{\@glswidestname}%
		\glstreenamebox{\glstreeindent}%
		{%
			\glsentryitem{##2}%
			\glstarget{##2}{\glossentryname{##2}}%
		}%
		\space%
		\glsuseri*{##2}%
		\ifglshassymbol{##2}{,\space\glossentrysymbol{##2}}{}%
		\par%
	}%
}%

% ---------- accronyms english definition -----------------------------------
\newacronymstyle{en_acr}%
	{\GlsUseAcrEntryDispStyle{long-short}}% based on long-short style
	{\GlsUseAcrStyleDefs{long-short}}% based on long-short style

% ---------- accronyms french definition ------------------------------------
\newacronymstyle{fr_acr}%
	{\GlsUseAcrEntryDispStyle{long-short}}% based on long-short style
	{%
		\GlsUseAcrStyleDefs{long-short}% based on long-short style	
		\renewcommand*{\genacrfullformat}[2]%
			{\glsuseri*{##1}##2\space(\firstacronymfont{\glsentryshort{##1}})}%
		\renewcommand*{\genplacrfullformat}[2]%
			{\glsuseri*{##1}##2\space(\firstacronymfont{\glsentryshortpl{##1}})}%
		\let\Genacrfullformat\genacrfullformat
		\let\Genplacrfullformat\genplacrfullformat
	}%

% ---------- accronyms bilangual definition ---------------------------------
\newacronymstyle{fr_en_acr}%
	{\GlsUseAcrEntryDispStyle{long-short}}% based on long-short style
	{%
		\GlsUseAcrStyleDefs{long-short}% based on long-short style	
		\renewcommand*{\genacrfullformat}[2]%
			{%
				\glsuseri*{##1}##2%
				\space(\firstacronymfont{\glsentryshort{##1}} pour %
				\textit{\glsentrydesc{##1}})%
			}%
		\renewcommand*{\genplacrfullformat}[2]
			{\glsuseri*{##1}##2\space(\firstacronymfont{\glsentryshortpl{##1}})}%
		\let\Genacrfullformat\genacrfullformat
		\let\Genplacrfullformat\genplacrfullformat
	}%

% ---------- dot accent key ------------------------------------------------
\glsaddkey{dot}% key
{	% default value
	\ensuremath{\dot{\glsentrytext{\glslabel}}}%
	\glsadd{op.dot}%
}{\glsentrydot}{\Glsentrydot}{\glsdot}{\Glsdot}{\GLSdot}% macros

% ---------- bar accent key ------------------------------------------------
\glsaddkey{bar}% key
{	% default value
	\ensuremath{\overline{\glsentrytext{\glslabel}}}
	\glsadd{op.bar}%
}{\glsentrybar}{\Glsentrybar}{\glsbar}{\Glsbar}{\GLSbar}% macros

% ---------- hat accent key ------------------------------------------------
\glsaddkey{hat}% key
{	% default value
	\ensuremath{\widehat{\glsentrytext{\glslabel}}}%
	\glsadd{op.hat}%
}{\glsentryhat}{\Glsentryhat}{\glshat}{\Glshat}{\GLShat}% macros

% ---------- tilde accent key ----------------------------------------------
\glsaddkey{tilde}% key
{	% default value
	\ensuremath{\widetilde{\glsentrytext{\glslabel}}}
	\glsadd{op.tilde}%
}{\glsentrytilde}{\Glsentrytilde}{\glstilde}{\Glstilde}{\GLStilde}% macros


% ===========================================================================
% =================== PUBLIC MACROS ========================================= =============================================================================

% ---------- dif -------------------------------------------------------
%  shortcut for upright d (differential)
\newcommand*{\dif}{\mathrm{d}}%

% ---------- stkout ----------------------------------------------------
% "strikout" line in the middle of equations
\newcommand*{\stkout}[1]%
{\ifmmode\text{\sout{\ensuremath{#1}}}\else\sout{#1}\fi}%

% ---------- sbu -------------------------------------------------------
% "sbu" macro : shortcut for upright indices (ISO/NIST standard)
\newcommand*{\sbu}[1]{_\mathrm{#1}}%

% ---------- " in math mode --------------------------------------------
% define char '"' as shortcut for "sbu" macro in math mode
% "qtmark" macro print an quotation mark
\begingroup\lccode`~=`"%
\lowercase{\endgroup\def~}#1{\sbu{#1}}%
\mathchardef\qtmark=\mathcode`"%
\AtBeginDocument{\mathcode`"=\string"8000}%

% ---------- glsvi -------------------------------------------------------
% show $a_b$ with link to "a" and variable "b" (italized indice)
% 4 arguments with 2 mandatory arguments and
% optional 1st and 2nd argument for adding accent on "a" and "b"
\newcommand*{\glsvi}[1][]%
{%
	\def\glosnom@ArgI{#1}%
	\glosnom@glsviRelay%
}%

% ---------- glsub -------------------------------------------------------
% show $a!b$ with link to "a" and "sub.b" (upright indice)
% optional first argument for adding math accents on a ("dot" or "tilde")
\newcommand*{\glsub}[3][]%
{%
	\glosnom@getMyGlsMacro{#1}%
	\ensuremath{\glosnom@MyGlsMacro{#2}[\sbu{\gls{sub.#3}}]}%
}%

% ---------- glsubs -------------------------------------------------------
% show $a!{b,c}$ with link "a", "sub.b", comma operator and "sub.c"
% optional first argument for adding math accents on a ("dot" or "tilde")
\newcommand*{\glsubs}[4][]%
{%
	\glosnom@getMyGlsMacro{#1}%
	\ensuremath{\glosnom@MyGlsMacro{#2}[\sbu{\gls{sub.#3},\gls{sub.#4}}]}%
	\glsadd{op.comma}%
}%

% ===========================================================================
% =================== PRIVATE MACROS ========================================
% ===========================================================================

% ---------- glosnom@getMyGlsMacro ------------------------------------------
\newcommand*{\glosnom@getMyGlsMacro}[1]%
{%
	\let\glosnom@MyGlsMacro\gls%
	\notblank{#1}%
	{%
		\ifstrequal{#1}{dot}{\let\glosnom@MyGlsMacro\glsdot}%
		{%
			\ifstrequal{#1}{bar}{\let\glosnom@MyGlsMacro\glsbar}%
			{%
				\ifstrequal{#1}{hat}{\let\glosnom@MyGlsMacro\glshat}%
				{%
					\ifstrequal{#1}{tilde}{\let\glosnom@MyGlsMacro\glstilde}%
					{%
						\PackageError{glosnomtools}{Unknown accent: #1}{}%
					}%
				}%
			}%
		}%	
	}{}%
}%

% ---------- glosnom@glsviRelay -------------------------------------------
% relay macro for two optional aguments in the glsvi macro
\newcommand*{\glosnom@glsviRelay}[3][]%
{%
	\expandafter\glosnom@getMyGlsMacro\expandafter{\glosnom@ArgI}%
	\let\glosnom@FirGls\glosnom@MyGlsMacro%
	\glosnom@getMyGlsMacro{#1}%
	\let\glosnom@SecGls\glosnom@MyGlsMacro%
	\ensuremath{\glosnom@FirGls{#2}[_{\glosnom@SecGls{#3}}]}%
}%